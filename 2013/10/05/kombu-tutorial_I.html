<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en-us">
<head>
   <meta http-equiv="content-type" content="text/html; charset=utf-8" />
   <title>kombu 入门教程(上)</title>
   <meta name="author" content="Peer Xu" />
   <link href="http://peerxu.github.com/" rel="alternate" title="Peer Studio Blog" type="application/atom+xml" />

   <!-- syntax highlighting CSS -->
   <link rel="stylesheet" href="/css/syntax.css" type="text/css" />

   <!-- Homepage CSS -->
   <link rel="stylesheet" href="/css/screen.css" type="text/css" media="screen, projection" />

	<!-- Google Analytics -->
	<script type="text/javascript">

	  var _gaq = _gaq || [];
	  _gaq.push(['_setAccount', 'UA-26349380-3']);
	  _gaq.push(['_trackPageview']);

	  (function() {
		var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
		ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
		var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
	  })();

	</script>
	<!-- Google Analytics end -->
</head>
<body>

<div class="site">
  <div class="title">
    <a href="/">Peer Studio Blog</a>
    <a class="extra" href="/">home</a>
  </div>
  
  <div id="post">
<h1>kombu 入门教程(上)</h1>

<h2>前言</h2>

<p>本文是<a href="https://github.com/celery/kombu">kombu框架</a>(一个基于python的消息队列框架)的入门教程. 文章会简单介绍消息队列中的基本概念和kombu框架的简单使用方法.</p>

<h2>Hello World</h2>

<p>我们来了解一下, 一个简单的消息队列里面, 应该包含以下的对象.</p>

<ol>
<li><strong>Producer</strong> -- 负责消息的发送</li>
<li><strong>Consumer</strong> -- 负责消息的接收</li>
<li><strong>Queue</strong> -- 负责消息的传输</li>
<li><strong>Exchange</strong> -- 负责消息的分发</li>
</ol>


<p>在我们的<strong>Hello World</strong>中, 我们只看到了创建<strong>Queue</strong>的过程, 其实一个完整消息队列应用程序是会包含上面所说的所有实体的.</p>

<p>但是kombu很贴心的为我们封装了一个便于使用的<strong>SimpleQueue</strong>类, 让我们能够快速地开发.</p>

<p>下面我们就围绕着这个<strong>SimpleQueue</strong>类来进行简单的试验:</p>

<pre><code>import kombu
conn = kombu.Connection('redis://localhost')
</code></pre>

<p>导入kombu模块, 并且创建一个连接, 连接到本地的Redis服务上(本文的介绍都是基于Redis作为消息队列后端)</p>

<pre><code>def message_process(body, message):
    print "[x] %s" body
    message.ack()
queue = conn.SimpleQueue('demo')
queue.consumer.callbacks = [message_process]
</code></pre>

<p>这里定义了一个<strong>message_process</strong>函数, 用于处理消息.
需要注意的是, 当消息处理完之后, 要发送调用message对象的ack方法来确保消息已经被正确处理.
如果没有确认的话, 那么消息依然放置在队列当中, 当作没有被处理.</p>

<p>之后创建了一个消息队列, 命名为<strong>demo</strong>. 并且给队列的consumer绑定了一个消息处理函数.</p>

<p>以上就是关于消息接收的一些过程, 下面继续介绍一下消息发送的过程.</p>

<pre><code>queue.put('hello,world')
</code></pre>

<p>创建消息队列的过程与消息接收的相同, 要注意的就是不需要为消息队列指定consumer的处理函数.
直接调用queue的put方法就可以发送消息了.</p>

<p>完整的代码如下:</p>

<p><em>receiver.py</em></p>

<pre><code>import kombu

def message_process(body, message):
    print "[x] %s" % body
    message.ack()

conn = kombu.Connection('redis://localhost')
queue = conn.SimpleQueue('demo')
queue.consumer.callbacks = [message_process]

queue.get()
</code></pre>

<p><em>sender.py</em></p>

<pre><code>import kombu

conn = kombu.Connection('redis://localhost')
queue = conn.SimpleQueue('demo')
queue.put('hello, world')
</code></pre>

<p>启动receiver:</p>

<pre><code>$ python receiver.py
</code></pre>

<p>发送消息:</p>

<pre><code>$ python sender.py
</code></pre>

<p>之后会在receiver的终端上看见:</p>

<pre><code>$ python receiver.py
[x] hello world
</code></pre>

<p>简单的消息队列应用就这样.</p>

<p>感谢阅读~</p>

</div>

<div id="related">
  <h2>Related Posts</h2>
  <ul class="posts">
    
      <li><span>08 Jul 2014</span> &raquo; <a href="/2014/07/08/choose-your-favorite-number-from-alibaba.html">老板, 要挑个号码么?</a></li>
    
      <li><span>03 Jul 2014</span> &raquo; <a href="/2014/07/03/google-ip-explorer-tutorial.html">Google IP Explorer使用教程</a></li>
    
      <li><span>12 Jun 2014</span> &raquo; <a href="/2014/06/12/send-request-to-restful-api-service-from-browser.html">在浏览器中调用RESTful API Service</a></li>
    
  </ul>
</div>

  
  <div class="footer">
    <div class="contact">
      <p>
        Peer Studio<br />
		Weibo<br />
		Twitter<br />
        Cofounder of <a href="http://github.com/">GitHub</a><br />
		pppeerxu@gmail.com
      </p>
    </div>
    <div class="contact">
      <p>
        <a href="http://github.com/peerxu/">github.com/PeerXu</a><br />
		<a href="http://weibo.com/peerstudio">weibo.com/peerstudio</a><br />
		<a href="http://twitter.com/peerxu">twitter.com/PeerXu</a><br />
      </p>
    </div>
    <div class="rss">
      <a href="atom.xml">
        <img src="/images/rss.png" alt="Subscribe to RSS Feed" />
      </a>
    </div>
  </div>
</div>

<a href="http://github.com/peerxu"><img style="position: absolute; top: 0; right: 0; border: 0;" src="http://s3.amazonaws.com/github/ribbons/forkme_right_red_aa0000.png" alt="Fork me on GitHub" /></a>

</body>
</html>
